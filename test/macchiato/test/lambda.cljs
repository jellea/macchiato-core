(ns macchiato.test.lambda
  (:require [cljs.test :refer-macros [is are deftest testing use-fixtures]]
            [macchiato.util.aws-lambda :as u.lambda]
            [macchiato.test.ring-spec :as r.s]
            [clojure.spec.alpha :as s]))

(deftest request-transform
  ;; test from https://docs.aws.amazon.com/lambda/latest/dg/eventsources.html#eventsources-api-gateway-request
  (let [lambda-request (js/JSON.parse "{\"v\": 3,\"rawBody\": \"\",\"normalizedHeaders\": {\"accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\",\"accept-encoding\": \"gzip, deflate, br\",\"accept-language\": \"en-US,en;q=0.9\",\"cloudfront-forwarded-proto\": \"https\",\"cloudfront-is-desktop-viewer\": \"true\",\"cloudfront-is-mobile-viewer\": \"false\",\"cloudfront-is-smarttv-viewer\": \"false\",\"cloudfront-is-tablet-viewer\": \"false\",\"cloudfront-viewer-country\": \"DE\",\"cookie\": \"gsScrollPos-1614=1737\",\"host\": \"1n76rhtv43.execute-api.eu-west-2.amazonaws.com\",\"upgrade-insecure-requests\": \"1\",\"user-agent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36\",\"via\": \"2.0 aac86dd0bb06b97ef178f97d0c65ee5f.cloudfront.net (CloudFront)\",\"x-amz-cf-id\": \"J3YeRkxkdZ5FT2Wt7a88yElRGRzLYtaMAt3D5CMVRVVaEKysxWoejA==\",\"x-amzn-trace-id\": \"Root=1-5a2ec9ff-31165bf678772e2304f00a7f\",\"x-forwarded-for\": \"88.73.59.146, 54.239.167.86\",\"x-forwarded-port\": \"443\",\"x-forwarded-proto\": \"https\"},\"lambdaContext\": {\"callbackWaitsForEmptyEventLoop\": false,\"logGroupName\": \"/aws/lambda/social-publisher\",\"logStreamName\": \"2017/12/11/[$LATEST]9fc7dab7ae0c4d318416bc501906b3db\",\"functionName\": \"social-publisher\",\"memoryLimitInMB\": \"128\",\"functionVersion\": \"$LATEST\",\"invokeid\": \"84fd214e-de9e-11e7-8c8b-b944db8d20d7\",\"awsRequestId\": \"84fd214e-de9e-11e7-8c8b-b944db8d20d7\",\"invokedFunctionArn\": \"arn:aws:lambda:eu-west-2:451279323778:function:social-publisher:latest\"},\"proxyRequest\": {  \"resource\": \"/17592186046493\",  \"path\": \"/17592186046493\",\"httpMethod\": \"GET\",\"headers\": {\"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\",\"Accept-Encoding\": \"gzip, deflate, br\",\"Accept-Language\": \"en-US,en;q=0.9\",\"CloudFront-Forwarded-Proto\": \"https\",\"CloudFront-Is-Desktop-Viewer\": \"true\",\"CloudFront-Is-Mobile-Viewer\": \"false\",\"CloudFront-Is-SmartTV-Viewer\": \"false\",\"CloudFront-Is-Tablet-Viewer\": \"false\",\"CloudFront-Viewer-Country\": \"DE\",\"Cookie\": \"gsScrollPos-1614=1737\",\"Host\": \"1n76rhtv43.execute-api.eu-west-2.amazonaws.com\",\"upgrade-insecure-requests\": \"1\",\"User-Agent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36\",\"Via\": \"2.0 aac86dd0bb06b97ef178f97d0c65ee5f.cloudfront.net (CloudFront)\",\"X-Amz-Cf-Id\": \"J3YeRkxkdZ5FT2Wt7a88yElRGRzLYtaMAt3D5CMVRVVaEKysxWoejA==\",\"X-Amzn-Trace-Id\": \"Root=1-5a2ec9ff-31165bf678772e2304f00a7f\",\"X-Forwarded-For\": \"88.73.59.146, 54.239.167.86\",\"X-Forwarded-Port\": \"443\",\"X-Forwarded-Proto\": \"https\"},  \"queryStringParameters\": {      \"json\": \"true\"  },\"pathParameters\": null,\"stageVariables\": {\"lambdaVersion\": \"latest\"},\"requestContext\": {\"requestTime\": \"11/Dec/2017:18:10:07 +0000\",\"path\": \"/latest/hello\",\"accountId\": \"451279323778\",\"protocol\": \"HTTP/1.1\",\"resourceId\": \"lj8sc6\",\"stage\": \"latest\",\"requestTimeEpoch\": 1513015807542,\"requestId\": \"84fc5dc2-de9e-11e7-ab04-994ed3638fed\",\"identity\": {\"cognitoIdentityPoolId\": null,\"accountId\": null,\"cognitoIdentityId\": null,\"caller\": null,\"apiKey\": \"\",\"sourceIp\": \"88.73.59.146\",\"accessKey\": null,\"cognitoAuthenticationType\": null,\"cognitoAuthenticationProvider\": null,\"userArn\": null,\"userAgent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36\",\"user\": null},  \"resourcePath\": \"/17592186046493\",\"httpMethod\": \"GET\",\"apiId\": \"1n76rhtv43\"},\"body\": null,\"isBase64Encoded\": false},  \"queryString\": {\"json\": \"true\"},\"env\": {\"lambdaVersion\": \"latest\"},\"headers\": {\"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\",\"Accept-Encoding\": \"gzip, deflate, br\",\"Accept-Language\": \"en-US,en;q=0.9\",\"CloudFront-Forwarded-Proto\": \"https\",\"CloudFront-Is-Desktop-Viewer\": \"true\",\"CloudFront-Is-Mobile-Viewer\": \"false\",\"CloudFront-Is-SmartTV-Viewer\": \"false\",\"CloudFront-Is-Tablet-Viewer\": \"false\",\"CloudFront-Viewer-Country\": \"DE\",\"Cookie\": \"gsScrollPos-1614=1737\",\"Host\": \"1n76rhtv43.execute-api.eu-west-2.amazonaws.com\",\"upgrade-insecure-requests\": \"1\",\"User-Agent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36\",\"Via\": \"2.0 aac86dd0bb06b97ef178f97d0c65ee5f.cloudfront.net (CloudFront)\",\"X-Amz-Cf-Id\": \"J3YeRkxkdZ5FT2Wt7a88yElRGRzLYtaMAt3D5CMVRVVaEKysxWoejA==\",\"X-Amzn-Trace-Id\": \"Root=1-5a2ec9ff-31165bf678772e2304f00a7f\",\"X-Forwarded-For\": \"88.73.59.146, 54.239.167.86\",\"X-Forwarded-Port\": \"443\",\"X-Forwarded-Proto\": \"https\"},\"pathParams\": {},\"body\": \"\",\"context\": {\"method\": \"GET\",  \"path\": \"/17592186046493\",\"stage\": \"latest\",\"sourceIp\": \"88.73.59.146\",\"accountId\": null,\"user\": null,\"userAgent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36\",\"userArn\": null,\"caller\": null,\"apiKey\": \"\",\"authorizerPrincipalId\": null,\"cognitoAuthenticationProvider\": null,\"cognitoAuthenticationType\": null,\"cognitoIdentityId\": null,\"cognitoIdentityPoolId\": null}}")
        ring-request (u.lambda/request->map lambda-request #())]
    (prn (s/explain :ring.request/request ring-request))))



(deftest response-transform
  (is true))
